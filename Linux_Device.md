
Linux 的设备管理是和文件系统紧密结合的，各种设备都以文件的形式存放在 /dev 目录下，称为设备文件。应用程序可以打开、关闭和读写这些设备文件，完成对设备的操作，就像操作普通的数据文件一样。为了管理这些设备，系统为设备编了号，每个设备号又分为主设备号和次设备号。主设备号用来区分不同种类的设备，而次设备号用来区分同一类型的多个设备。对于常用设备，Linux 有约定俗成的编号，如硬盘的主设备号是 3。

一个字符设备或者块设备都有一个主设备号和次设备号。主设备号和次设备号统称为设备号。主设备号用来表示一个特定的驱动程序。次设备号用来表示使用该驱动程序的各设备。例如一个嵌入式系统，有两个 LED 指示灯，LED 灯需要独立的打开或者关闭。那么，可以写一个LED 灯的字符设备驱动程序，可以将其主设备号注册成5号设备，次设备号分别为 1 和 2。这里，次设备号就分别表示两个 LED 灯。

可以输入以下命令查看各设备号：

```
ll /dev |more
```

将会显示以下打印信息：

```
crw-rw-rw-    1 root     root        5,   2 Jan  1  2000 ptmx
```

- 第一个字母表示设备的类型：'c' 表示字符设备；'b' 表示块设备；'-' 表示普通文件；'d' 表示目录文件；'l' 表示符号链接文件；'p' 命令管道文件；'s'表示套接字文件。
- 后面紧接着的 9 个符号表示 3 组权限，u 所有人的权限；g 所有组的权限；o 其他人的权限。
- 真正的设备号是 '5, 2' 。5 表示的是主设备号， 2 表示的是此设备号。

现在的 Linux 内核允许多个驱动共享一个主设备号，但更多的设备都遵循一个驱动对一个主设备号的原则。

```
crw-------    1 root     root       90,  11 Jan  1  2000 mtd5ro
crw-------    1 root     root       90,  12 Jan  1  2000 mtd6
crw-------    1 root     root       90,  13 Jan  1  2000 mtd6ro
```

如上所示，90 为主设备号，11、12、13 分别是 mtd5ro、mtd6、mtd6ro 3 个设备的次设备号。内核由次设备号确定当前所指向的是哪个设备。根据所编写的驱动程序，可以从内核那里得到一个直接指向设备的指针，或者使用次设备号作为一个设备本地数组的索引。但不论如何，内核自身几乎对次设备号关联不大。


## 静态分配设备号

静态分配设备号，就是驱动程序开发者，静态地指定一个设备号。对于一部分常用的设备，内核开发者已经为其分配了设备号。这些设备号可以在内核源码 documentation/ devices.txt 文件中找到。如果只有开发者自己使用这些设备驱动程序，那么其可以选择一个尚未使用的设备号。在不添加新硬件的时候，这种方式不会产生设备号冲突。但是当添加新硬件时，则很可能造成设备号冲突，影响设备的使用。


## 动态分配设备号

由于静态分配设备号存在冲突的问题，所以内核社区建议开发者使用动态分配设备号的方法。动态分配设备号的函数是alloc_chrdev_region()。

