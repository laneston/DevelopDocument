本编文章是关于交叉编译链的学习笔记当中的核心篇目。文章围绕makefile文件的编写方式，向读者讲述如何在ubuntu平台上用GCC交叉编译链编译出STM32F4xx系列的执行文件（bin)。

# 什么是Makefile

Makefile文件表述的是文件的依赖关系，告诉编译器怎么去编译和链接当中的文件。如果能掌握Makefile文件的编写方法，就能脱离可视化编译器，使用编译链工具编译出所需的目标文件。

## 编译和链接

编译和链接是获得目标文件的主要方式，在常见的stm32f1xx/stm32f4xx系列的编程任务中，我们可能会用到keil/MDK这个工具，当点击其中的build按键时，我们就能在输出文件夹中获得bin（二进制）或者HEX（十六进制）文件。之后，我们就可以通过MDK自带的烧录工具，使用JLink/STLink将目标文件烧录到芯片的Flash当中，抑或是通过ISP工具烧录到芯片的Flash当中。

在这个过程当中，编译器已经帮我们执行了编译和链接两个步骤。以下我会通过简单的例子说明这一个过程是如何在编译链上体现的。

创建一个名为 main.c 的文件，并写入以下代码：

```C
#include <stdio.h>

int main(int argv, char argc[])
{
    int num1=0;
    int num2=0;
    int revalue=0;

    printf("please input num 1\r\n");
    scanf("%d",&num1);

    printf("please input num 2\r\n");
    scanf("%d",&num2);

    revalue = num1 + num2;

    printf("result is ：%d\r\n", revalue);
    return 0;
}
```

我们在Ubuntu平台上用 **GCC编译器** 编译以上代码：在当前文件夹内，使用以下命令：

```
gcc main.c -o app
```

<img src="https://github.com/laneston/Pictures/blob/master/Post-Makefile/20200812144507.jpg" width="50%" height="50%">

我们可以从上图所示，得到一个名为 app 的目标文件。

输入以下命令即可执行目标文件:

```
./app
```
以上过程便是我们说的编译与链接。

### 编译

其实，一个完成的编译过程包括：预处理、编译、汇编、链接。我们通常把 预处理+编译+汇编 统称为编译。

1. **预处理：** 展开头文件/宏替换/去掉注释/条件编译；
2. **编译：**   检查语法，生成汇编；
3. **汇编：**   汇编代码转换机器码；
4. **链接：**    链接到一起生成可执行程序 。

我们先了解一下编译器常用的的命令：

|  选项 |含义|
|:-----:|:---|
|-v|查看gcc编译器的版本，显示gcc执行时的详细过程|
|-o|指定输出文件名为file，这个名称不能跟源文件名同名|
|-E|只预处理，不会编译、汇编、链接|
|-S|只编译，不会汇编、链接|
|-c|编译和汇编，不会链接|

如果我们想看编译出的中间文件，可以写入以下命令：

```
gcc -S main.c
```

<img src="https://github.com/laneston/Pictures/blob/master/Post-Makefile/20200812152754.jpg" width="50%" height="50%">

以上我们可以看到，文件夹中多了一个 .s 文件，这是汇编格式的文件。

如果我们写入以下命令，即可得到常用的中间文件（.o 文件）：

```
gcc -c main.c
```

### 链接

链接顾名思义是为某些有关联的目标建立关系。在这个过程当中，主要是链接函数和全局变量。在链接过程当中，链接器不理会源文件（.c文件），只管编译时生成的中间文件（.o文件）。我们在使用keil编译时，在输出文件夹中，也可以看到相关的 .o 文件，那就是编译器生成的中间文件。

我们可以使用以下命令，将 main.o 链接生成目标文件：

```
gcc main.o -o app
```

# 如何编写Makefile

经过以上的学习，我们已经大致了解编译和链接到底是怎么回事了。我们也清楚，即便不用 Makefile 文件也能编译出目标文件。那我们继续学习下去，了解 Makefile 在编译当中充当的角色的重要性。

我们编写 Makefile 的规则是：

1. 如果这个工程没有编译过，那么我们的所有c文件都要编译并被链接。
2. 如果这个工程的某几个c文件被修改，那么我们只编译被修改的c文件，并链接目标程序。
3. 如果这个工程的头文件被改变了，那么我们需要编译引用了这几个头文件的c文件，并链接目标程序。

## Makefile的编写规则

target... : prerequisites ...

    command

- **target** 是一个目标文件，可以是中间文件，也可以是执行文件，还可以是一个标签（Label）。
- **prerequisites** 就是要生成那个 **target** 所需要的文件。
- **command** 是 make 需要执行的命令（任意的Shell命令）。需要注意的是，命令要以一个Tab键作为开头。
